/*
formBuilder - git@github.com:kevinchappell/formBuilder.git
Version: 1.3.0
Author: Kevin Chappell <kevin.b.chappell@gmail.com>
*/
"use strict";!function(e){var t=function(t,l){var a,i,n=function(){return!1},o={disableFields:{},defaultFields:[],roles:[{value:1,label:"Administrator"}],showWarning:!1,serializePrefix:"frmb",labels:{add:"Add Item",allowSelect:"Allow Select",autocomplete:"Autocomplete",cannotBeEmpty:"This field cannot be empty",checkboxGroup:"Checkbox Group",checkbox:"Checkbox",checkboxes:"Checkboxes","class":"Class",clearAllMessage:"Are you sure you want to remove all items?",clearAll:"Clear All",close:"Close",copy:"Copy To Clipboard",date:"Date Field",description:"Help Text",descriptionField:"Description",devMode:"Developer Mode",disableFields:"These fields cannot be moved.",editNames:"Edit Names",editorTitle:"Form Elements",editXML:"Edit XML",fieldVars:"Field Variables",fieldRemoveWarning:"Are you sure you want to remove this field?",getStarted:"Drag a field from the right to this area",hide:"Edit",label:"Label",labelEmpty:"Field Label cannot be empty",limitRole:"Limit access to one or more of the following roles:",mandatory:"Mandatory",maxLength:"Max Length",minOptionMessage:"This field requires a minimum of 2 options",name:"Name",no:"No",off:"Off",on:"On",optional:"optional",optionas:"Options",optionLabelPlaceholder:"Label",optionValuePlaceholder:"Value",optionEmpty:"Option value required",paragraph:"Paragraph",preview:"Preview",radioGroup:"Radio Group",radio:"Radio",removeMessage:"Remove Element",remove:"&#215;",required:"Required",richText:"Rich Text Editor",roles:"Limit Access",save:"Save Template",selectOptions:"Select Items",select:"Select",selectionsMessage:"Allow Multiple Selections",text:"Text Field",warning:"Warning!",viewVars:"View Field Variables",viewXML:"View XML",yes:"Yes"}},s={};s.uniqueArray=function(e){return e.filter(function(e,t,l){return l.indexOf(e)===t})},s.startMoving=function(t,l){t=t,l.item.addClass("moving"),a=e("li",this).index(l.item)},s.stopMoving=function(t,l){t=t,l.item.removeClass("moving"),i&&(e(l.sender).sortable("cancel"),e(this).sortable("cancel"))},s.safename=function(e){return e.replace(/\s/g,"-").replace(/[^a-zA-Z0-9\-]/g,"").toLowerCase()},s.forceNumber=function(e){return e.replace(/[^0-9]/g,"")},s.initTooltip=function(e){var t=e.find(".tooltip");e.mouseenter(function(){t.outerWidth()>200&&t.addClass("max-width"),t.css("left",e.width()+14),t.stop(!0,!0).fadeIn("fast")}).mouseleave(function(){e.find(".tooltip").stop(!0,!0).fadeOut("fast")}),t.hide()},s.save=function(){L.children("li").not(".disabled").each(function(){s.updatePreview(e(this))}),c.val(L.toXML())},s.updatePreview=function(t){var l;e(".prev-holder",t).html(l)},s.nameAttr=function(e){var t=(new Date).getTime();return e+"-"+t},s.updateMultipleSelect=function(){L.on("change",'input[name="multiple"]',function(){var t=e(this).parents(".fields:eq(0)").find(".sortable-options input.select-option");this.checked?t.each(function(){e(this).prop("type","checkbox")}):t.each(function(){e(this).removeAttr("checked").prop("type","radio")})})},s.htmlEncode=function(t){return e("<div/>").text(t).html()},s.htmlDecode=function(t){return e("<div/>").html(t).text()},s.validateForm=function(){var t=[];e('input[name="label"], input[type="text"].option',L).each(function(){if(""===e(this).val()){var l=e(this).parents("li.form-field"),a=e(this);t.push({field:l,error:d.labels.labelEmpty,attribute:a})}}),t.length&&(alert("Error: "+t[0].error),e("html, body").animate({scrollTop:t[0].field.offset().top},1e3,function(){var l=e(".toggle-form",t[0].field).attr("id");e(".toggle-form",t[0].field).addClass("open").parent().next(".prev-holder").slideUp(250),e("#"+l+"-fld").slideDown(250,function(){t[0].attribute.addClass("error")})}))},s.disabledTT=function(t){var l=t.attr("data-tooltip");if(l){t.removeAttr("title").data("tip_text",l);var a=e("<p/>",{"class":"frmb-tt"}).html(l);t.append(a),a.css({top:-a.outerHeight(),left:-15}),t.mouseleave(function(){e(this).attr("data-tooltip",t.data("tip_text")),e(".frmb-tt").remove()})}},String.prototype.toCamelCase=function(){return this.replace(/(\-\w)/g,function(e){return e[1].toUpperCase()})},s.markup=function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],l=arguments.length<=2||void 0===arguments[2]?"":arguments[2];t=B(t),l=Array.isArray(l)?l.join(""):l;var a=["input"],i=-1===a.indexOf(e)?"<"+e+" "+t+">"+l+"</"+e+">":"<"+e+" "+t+"/>";return i};var r=function(t){var l,a=Object.assign({},{label:t.label},t.attrs,t.meta),i=a.roles.map(function(e){return e.type="checkbox",e}),n=["required","label","description","class","roles","name"];return a.name=a.name||s.nameAttr(a.type),-1!==e.inArray(a.type,["checkbox","select","checkbox-group","date","autocomplete"])||a.maxLength||(a.maxLength="",n.push("maxLength")),a.roles={options:i,value:1,type:"checkbox"},delete a.type,l=s.uniqueArray(n.concat(Object.keys(a))).map(function(e){var t={name:e};return"object"==typeof a[e]?Object.assign(t,a[e]):t.value=a[e],t})},d=e.extend(o,l),c=e(t),p="frmb-"+e("ul[id^=frmb-]").length++,u="",f=1,m=p+"-control-box",v=["text","autocomplete","select","rich-text","date","radio-group","checkbox","checkbox-group"],h=e("<ul/>",{id:m,"class":"frmb-control"}),b=v.map(function(t){var l=t.toCamelCase(),a={label:d.labels[l],meta:{description:"",roles:d.roles},attrs:{type:t,"class":t+"-input",required:{value:1,type:"checkbox"}}};return a.properties=r(a),-1!==e.inArray(t,["select","checkbox-group","radio-group"])&&(a.options=[{fields:[{value:"Option 1 Label"},{value:"Option 2 Label"}]}],a.properties.options=a.options),e("<li/>",a.attrs).data("fieldData",a).html(a.label).removeAttr("type")});h.append(b);var g=e("<h4/>").html(d.labels.editorTitle),x=e("<h4/>").html(d.labels.preview),y=e("<a/>",{id:p+"-export-xml",text:d.labels.viewXML,"class":"view-xml"}),k=e("<a/>",{id:p+"-allow-select",text:d.labels.allowSelect,"class":"allow-select"}).prop("checked","checked"),w=e("<a/>",{id:p+"-edit-xml",text:d.labels.editXML,"class":"edit-xml"}),C=e("<a/>",{id:p+"-edit-names",text:d.labels.editNames,"class":"edit-names"}),_=e("<a/>",{id:p+"-clear-all",text:d.labels.clearAll,"class":"clear-all"}),T=e("<div/>",{id:p+"-save","class":"save-btn-wrap",title:d.labels.save}).html('<a class="save fb-button primary"><span>'+d.labels.save+"</span></a>"),M=e("<a/>",{id:p+"-view-vars","class":"view-vars",title:d.labels.viewVars}).html(d.labels.viewVars),E=e("<div/>",{id:p+"-action-links-inner","class":"action-links-inner"}).append(w," | ",M," | ",C," | ",k," | ",_," |&nbsp;"),O=e("<span/>",{"class":"dev-mode-link"}).html(d.labels.devMode+" "+d.labels.off),A=e("<div/>",{id:p+"-action-links","class":"action-links"}).append(E,O),L=e("<ul/>").attr("id",p).addClass("frmb").sortable({cursor:"move",opacity:.9,beforeStop:function(t,l){t=t;var a=e("> li",L).length-1,n=l.placeholder.index();i=1>=n||n===a},start:s.startMoving,stop:s.stopMoving,cancel:"input, .disabled, .sortable-options, .add, .btn, .no-drag, .prev-holder select",placeholder:"frmb-placeholder"});h.sortable({helper:"clone",opacity:.9,connectWith:L,cursor:"move",placeholder:"ui-state-highlight",start:s.startMoving,stop:s.stopMoving,revert:150,remove:function(t,l){0===a?h.prepend(l.item):e("li:eq("+(a-1)+")",h).after(l.item)},update:function(t,l){c.stopIndex=0===e("li",L).index(l.item)?"0":e("li",L).index(l.item),e("li",L).index(l.item)<0?e(this).sortable("cancel"):S(l.item,!0)},receive:function(t,l){(l.sender.hasClass("frmb")||l.sender.hasClass("frmb-control"))&&e(l.sender).sortable("cancel")}}),c.before(L).parent().prepend(x).addClass("frmb-wrap").append(A,y,T);var D=e("<div/>",{id:p+"-cb-wrap","class":"cb-wrap"}).append(g,h),F=e(".frmb-wrap").before(D).append(A),I=function(){if(0===e(this).parents("li.disabled").length){if("label"===e(this).name&&""===e(this).val())return alert("Error: "+d.labels.labelEmpty);s.save()}};e("input, select",L).on("change",I),e("input, select",L).on("blur",I),c.getTemplate=function(){var t=""!==c.val()?e.parseXML(c.val()):!1,l=e(t).find("field");if(l.length>0)l.each(function(){S(e(this))});else if(!t){if(d.defaultFields.length)for(var a=d.defaultFields.length-1;a>=0;a--)N(d.defaultFields[a]);else F.addClass("empty").attr("data-content",d.labels.getStarted);q()}};var q=function(){var t='<li class="disabled __POSITION__">__CONTENT__</li>';d.disableFields.before&&!e(".disabled.before",L).length&&L.prepend(t.replace("__POSITION__","before").replace("__CONTENT__",d.disableFields.before)),d.disableFields.after&&!e(".disabled.after",L).length&&L.append(t.replace("__POSITION__","after").replace("__CONTENT__",d.disableFields.after))},S=function(e){var t=e.data("fieldData");N(t),F.removeClass("empty"),q()},N=function(t){var l="",a=s.markup("a",{"class":"del-button btn",title:d.labels.removeMessage,id:"del_"+f},d.labels.remove),i=s.markup("a",{id:"frm-"+f,"class":"toggle-form btn icon-pencil",title:d.labels.hide}),n=s.markup("span",{"class":"field-label"},t.label),o=s.markup("span",{"class":"required-asterisk"},"*"),r=t.description?s.markup("span",{"class":"tooltip-element",tooltip:t.description},"?"):"",p=s.markup("div",{"class":"legend"},[a,n,r,o,i]),u=s.markup("div",{id:"frm-"+f+"-fld","class":"field-properties"},P(t.properties));l=s.markup("li",{id:"frm-"+f+"-item","class":t.attrs.type+" form-field"},[p,V(t),u]),c.stopIndex?e("li",L).eq(c.stopIndex).after(l):L.append(l),e(document.getElementById("frm-"+f+"-item")).hide().slideDown(250),f++,s.save()},B=function(e){var t=[];for(var l in e)e.hasOwnProperty(l)&&t.push(l+'="'+e[l]+'"');return t.join(" ")},P=function(e){return e.map(function(e){var t=s.markup("div",{"class":"field-property "+e.name+"-wrap"},j(e));return t})},j=function U(e){var t=arguments.length<=1||void 0===arguments[1]?"field":arguments[1];console.log(e),t=e.name||t;var l=(t+"-"+f).replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),a=e.label||d.labels[t.toCamelCase()]||"",i=e.options||[],n=e.fields||[],o=e.type||"text",r=e.value||"",c=[];return e.options&&(i=e.options.map(function(e){return U(e,t)}),n=s.markup("div",{"class":"property-options"},i)),c.push(s.markup("input",{type:o,name:l,value:r,id:l,"class":"edit-"+t})),c.push(s.markup("label",{"for":l},a)),c.push(c,n),c.join("")},V=function(e){var t={};return t.text=function(e){var t=B(e.attrs),l="<input "+t+">",a=e.attrs.value||"",i="<textarea "+t+">"+a+"</textarea>",n='<label for="'+e.attrs.id+'">'+e.label+"</label>",o={};return o.text=n+l,o.password=o.text,o.autocomplete=o.text,o.date=o.text,o.checkbox=l+n,o.radio=o.checkbox,o.textArea=n+i,o[e.attrs.type]},t.password=Object.assign(t.text),t.email=t.text,t.date=t.text,t.checkbox=t.text,t.autocomplete=t.text,t.select=function(e){var t=void 0,l=e.attrs,a=void 0;for(e.options.reverse(),a=e.options.length-1;a>=0;a--)t+='<option value="'+e.options[a].value+'">'+e.options[a].label+"</option>";return"<"+l.type+">"+t+"</"+l.type+">"},'<div class="prev-holder">'+t[e.attrs.type](e)+"</div>"},X=function(e,t,l,a){var i=a?"checkbox":"radio";return"object"!=typeof e?e={label:"",value:""}:(e.label=e.hasOwnProperty("label")?e.label:"",e.value=e.hasOwnProperty("value")?e.value:""),u="<li>",u+='<input type="'+i+'" '+l+' class="select-option" name="'+t+'" />',u+='<input type="text" class="option-label" placeholder="'+d.labels.optionLabelPlaceholder+'" value="'+e.label+'" />',u+='<input type="text" class="option-value" placeholder="'+d.labels.optionValuePlaceholder+'" value="'+e.value+'" />',u+='<a href="#" class="remove btn" title="'+d.labels.removeMessage+'">'+d.labels.remove+"</a>",u+="</li>"};L.on("click",".remove",function(t){t.preventDefault();var l=e(this).parents(".sortable-options:eq(0)").children("li").length;2>=l?alert("Error: "+d.labels.minOptionMessage):e(this).parent("li").slideUp("250",function(){e(this).remove()})}),L.on("click",".toggle-form",function(t){t.preventDefault();var l=e(this).attr("id");e(this).toggleClass("open").parent().next(".prev-holder").slideToggle(250),e(document.getElementById(l+"-fld")).slideToggle(250,function(){})}),L.on("keyup",".edit-label",function(t){e(".field-label",e(this).closest("li")).html(e(this).val())}),L.on("keyup","input.error",function(){e(this).removeClass("error")}),L.on("keyup",".edit-description",function(t){t.preventDefault();var l=e(".tooltip-element",e(this).closest("li"));if(""!==e(this).val())if(l.length)l.attr("tooltip",e(this).val()).css("display","inline-block");else{var a='<span class="tooltip-element" tooltip="'+e(this).val()+'">?</span>';e(".toggle-form",e(this).closest("li")).before(a)}else l.length&&l.css("display","none")}),s.updateMultipleSelect(),L.on("keyup",".edit-name",function(){e(this).val(s.safename(e(this).val())),""===e(this).val()?e(this).addClass("field_error").attr("placeholder",d.labels.cannotBeEmpty):e(this).removeClass("field_error")}),L.on("keyup","input.fld-max-length",function(){e(this).val(s.forceNumber(e(this).val()))}),L.on("click",".del-button",function(t){t.preventDefault();var l=e("<h3/>").html("<span></span>"+d.labels.warning),a=e(this).attr("id").replace(/del_/,""),i=e(this),n=e(document.getElementById("frm-"+a+"-item")),o=i.offset().left-e(window).scrollLeft(),r=i.offset().top-e(window).scrollTop();d.showWarning?jQuery("<div />").append(l,d.labels.fieldRemoveWarning).dialog({modal:!0,resizable:!1,width:300,dialogClass:"ite-warning",open:function(){e(".ui-widget-overlay").css({opacity:0})},position:[o-282,r-178],buttons:[{text:d.labels.yes,click:function(){n.slideUp(250,function(){e(this).remove(),s.save()}),e(this).dialog("close")}},{text:d.labels.no,"class":"cancel",click:function(){e(this).dialog("close")}}]}):n.slideUp(250,function(){e(this).remove(),s.save()})}),L.on("click",".edit-required",function(){var t=e(this).parents("li.form-field").find(".required-asterisk");t.toggle()}),L.on("click",".edit-roles",function(){var t=e(this).siblings(".property-options"),l=e(this);t.slideToggle(250,function(){l.is(":checked")||e('input[type="checkbox"]',t).removeAttr("checked")})}),L.on("click",".add-checkbox",function(){return e(this).parent().before(X()),!1}),L.on("mouseenter","li.disabled .form-element",function(){s.disabledTT(e(this))}),L.on("click",".add-option",function(t){t.preventDefault();var l=e(this).parents(".fields").first().find('input[name="multiple"]')[0].checked,a=e(this).parents(".fields").find(".select-option:eq(0)").attr("name");e(this).parents(".fields").first().find(".sortable-options").append(X(!1,a,!1,l)),s.updateMultipleSelect()}),L.on("click",".close_field",function(t){t.preventDefault(),e(this).parents("li.form-field").find(".toggle-form").trigger("click")}),L.delegate("click",".add_rd",function(t){t.preventDefault(),e(this).parent().before(X(!1,e(this).parents(".field-properties").attr("id")))}),e(".field-properties .fields .remove, .frmb .del-button").on("hover",function(){e(this).parents("li.form-field").toggleClass("delete")}),e(document.getElementById(p+"-export-xml")).click(function(t){t.preventDefault();var l=c.val(),a=e("<pre />").text(l);a.dialog({resizable:!1,modal:!0,width:720,dialogClass:"frmb-xml",overlay:{color:"#333333"}})}),e(document.getElementById(p+"-view-vars")).click(function(t){t.preventDefault();var l='<table width="100%">';l+='<tr><td width="50%" height="30"><strong>'+d.labels.fieldVars+'</strong></td><td align="center"><strong>'+d.labels.copy+"</strong></td></tr>",L.children("li").not(".disabled").each(function(){l+="<tr><td>$__"+e('input[name="name"]',e(this)).val()+'__</td><td align="center"><span id='+e('input[name="name"]',e(this)).val()+"_"+Math.random().toString(36).substr(2,6)+'_var" class="copy-var clipboard" data-clipboard-text="$__'+e('input[name="name"]',e(this)).val()+'__"></span></td></tr>'}),l+="</table>",e("<div />").html(l).dialog({modal:!0,width:400,dialogClass:"spigit-field-vars",overlay:{color:"#333333"},open:function(){e(".copy-var").each(function(){var t=e(this).attr("id"),l=new n(document.getElementById(t));l.on("load",function(t){t.on("complete",function(){e(".copy-var").removeClass("copied"),e(this).addClass("copied")})})})}})}),e(document.getElementById(p+"-clear-all")).click(function(e){if(e.preventDefault(),window.confirm(d.labels.clearAllMessage)){L.empty(),c.val(""),s.save();var t={label:[d.labels.descriptionField],name:["content"],required:"true",description:d.labels.mandatory};appendNewField(t),L.prepend(d.disableFields.before),L.append(d.disableFields.after)}}),e(document.getElementById(p+"-save")).click(function(e){e.preventDefault(),F.hasClass("edit-xml")||s.save(),s.validateForm(e)});var R=!1,W=[],z="68,69,86";e(".save.fb-button").mouseover(function(){R=!0}).mouseout(function(){R=!1}),e(document.documentElement).keydown(function(t){W.push(t.keyCode),W.toString().indexOf(z)>=0&&(e(".action-links").toggle(),e(".view-xml").toggle(),W=[])}),e(".dev-mode-link").click(function(t){t.preventDefault();var l=e(this);F.toggleClass("dev-mode"),l.parent().css("opacity",1),F.hasClass("dev-mode")?(l.siblings(".action-links-inner").css("width","100%"),l.html(d.labels.devMode+" "+d.labels.on).css("color","#8CC63F")):(l.siblings(".action-links-inner").css("width",0),l.html(d.labels.devMode+" "+d.labels.off).css("color","#666666"),R=!1,e(".action-links").toggle(),e(".view-xml").toggle())}),e(document.getElementById(p+"-edit-names")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e(".name_wrap",L).slideToggle(250,function(){F.toggleClass("edit-names")})}),e(document.getElementById(p+"-allow-select")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e(".allow-multi, .select-option",L).slideToggle(250,function(){F.toggleClass("allow-select")})}),e(document.getElementById(p+"-edit-xml")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e("textarea.idea-template").show(),e(".template-textarea-wrap").slideToggle(250),F.toggleClass("edit-xml")}),c.parent().find('p[id*="ideaTemplate"]').remove(),c.wrap('<div class="template-textarea-wrap"/>'),c.getTemplate()};e.fn.formBuilder=function(l){var a=this;return a.each(function(){var a=e(this);if(!a.data("formBuilder")){var i=new t(this,l);a.data("formBuilder",i)}})}}(jQuery),function(e){e.fn.toXML=function(t){var l={prepend:"",attributes:["class"]},a=e.extend(l,t),i="";return this.each(function(){var t=0,l=1;e(this).children().length>=1&&(i+="<form-template>\n	<fields>",e(this).children().each(function(){var n=e(this);if(!n.hasClass("moving")&&!n.hasClass("disabled"))for(var o=0;o<a.attributes.length;o++){var s=e("input.required",n).is(":checked")?'required="true" ':'required="false" ',r=e('input[name="multiple"]',n).is(":checked"),d=r?'style="multiple" ':"",c=n.attr(a.attributes[o]),p='type="'+c+'" ',u='name="'+e("input.fld-name",n).val()+'" ',f='label="'+e("input.fld-label",n).val()+'" ',m=e.map(e("input.roles-field:checked",n),function(e){return e.value}).join(","),v=""!==m?'role="'+m+'" ':"",h='description="'+e("input.fld-description",n).val()+'" ',b=e("input.fld-max-length",n).val(),g='max-length="'+(void 0!==b?b:"")+'" ',x="select"!==c&&"checkbox-group"!==c?"/":"";i+="\n		<field "+u+f+d+v+h+(""!==b&&void 0!==b?g:"")+s+p+x+">",("select"===c||"checkbox-group"===c)&&(l=1,e("input[type=text][class=option]",n).each(function(){if("title"!==e(this).attr("name")){var t=e(this).prev().is(":checked")?' selected="true"':"";i+="\n			<option"+t+">"+e(this).val()+"</option>"}l++}),i+="\n		</field>")}t++}),i+="\n	</fields>\n</form-template>")}),i}}(jQuery);
/*
formBuilder - git@github.com:kevinchappell/formBuilder.git
Version: 1.3.0
Author: Kevin Chappell <kevin.b.chappell@gmail.com>
*/
"use strict";!function(e){var t=function(t,l){var a,i,o={disableFields:{},defaultFields:[],roles:[{value:1,label:"Administrator"}],showWarning:!1,serializePrefix:"frmb",labels:{add:"Add Item",allowSelect:"Allow Select",autocomplete:"Autocomplete",cannotBeEmpty:"This field cannot be empty",checkboxGroup:"Checkbox Group",checkbox:"Checkbox",checkboxes:"Checkboxes","class":"Class",clearAllMessage:"Are you sure you want to remove all items?",clearAll:"Clear All",close:"Close",copy:"Copy To Clipboard",date:"Date Field",description:"Help Text",descriptionField:"Description",devMode:"Developer Mode",disableFields:"These fields cannot be moved.",editNames:"Edit Names",editorTitle:"Form Elements",editXML:"Edit XML",fieldRemoveWarning:"Are you sure you want to remove this field?",getStarted:"Drag a field from the right to this area",hide:"Edit",label:"Label",labelEmpty:"Field Label cannot be empty",limitRole:"Limit access to one or more of the following roles:",mandatory:"Mandatory",maxLength:"Max Length",minOptionMessage:"This field requires a minimum of 2 options",name:"Name",no:"No",off:"Off",on:"On",optional:"optional",options:"Options",optionLabelPlaceholder:"Label",optionValuePlaceholder:"Value",optionEmpty:"Option value required",paragraph:"Paragraph",preview:"Preview",radioGroup:"Radio Group",radio:"Radio",removeMessage:"Remove Element",remove:"&#215;",required:"Required",richText:"Rich Text Editor",roles:"Limit Access",save:"Save Template",selectOptions:"Select Items",select:"Select",selectionsMessage:"Allow Multiple Selections",text:"Text Field",warning:"Warning!",viewXML:"View XML",yes:"Yes"}},n={};n.uniqueArray=function(e){return e.filter(function(e,t,l){return l.indexOf(e)===t})},n.startMoving=function(t,l){t=t,l.item.addClass("moving"),a=e("li",this).index(l.item)},n.stopMoving=function(t,l){t=t,l.item.removeClass("moving"),i&&(e(l.sender).sortable("cancel"),e(this).sortable("cancel"))},n.safename=function(e){return e.replace(/\s/g,"-").replace(/[^a-zA-Z0-9\-]/g,"").toLowerCase()},n.forceNumber=function(e){return e.replace(/[^0-9]/g,"")},n.initTooltip=function(e){var t=e.find(".tooltip");e.mouseenter(function(){t.outerWidth()>200&&t.addClass("max-width"),t.css("left",e.width()+14),t.stop(!0,!0).fadeIn("fast")}).mouseleave(function(){e.find(".tooltip").stop(!0,!0).fadeOut("fast")}),t.hide()},n.save=function(){M.children("li").not(".disabled").each(function(){n.updatePreview(e(this))}),c.val(M.toXML())},n.updatePreview=function(t){var l;e(".prev-holder",t).html(l)},n.nameAttr=function(e){var t=(new Date).getTime();return e+"-"+t},n.htmlEncode=function(t){return e("<div/>").text(t).html()},n.htmlDecode=function(t){return e("<div/>").html(t).text()},n.validateForm=function(){var t=[];e('input[name="label"], input[type="text"].option',M).each(function(){if(""===e(this).val()){var l=e(this).parents("li.form-field"),a=e(this);t.push({field:l,error:s.labels.labelEmpty,attribute:a})}}),t.length&&(alert("Error: "+t[0].error),e("html, body").animate({scrollTop:t[0].field.offset().top},1e3,function(){var l=e(".toggle-form",t[0].field).attr("id");e(".toggle-form",t[0].field).addClass("open").parent().next(".prev-holder").slideUp(250),e("#"+l+"-fld").slideDown(250,function(){t[0].attribute.addClass("error")})}))},n.disabledTT=function(t){var l=t.attr("data-tooltip");if(l){t.removeAttr("title").data("tip_text",l);var a=e("<p/>",{"class":"frmb-tt"}).html(l);t.append(a),a.css({top:-a.outerHeight(),left:-15}),t.mouseleave(function(){e(this).attr("data-tooltip",t.data("tip_text")),e(".frmb-tt").remove()})}},String.prototype.toCamelCase=function(){return this.replace(/(\-\w)/g,function(e){return e[1].toUpperCase()})},n.markup=function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],l=arguments.length<=2||void 0===arguments[2]?"":arguments[2];t=q(t),l=Array.isArray(l)?l.join(""):l;var a=["input"],i=-1===a.indexOf(e)?"<"+e+" "+t+">"+l+"</"+e+">":"<"+e+" "+t+"/>";return i};var r=function(t){console.log(t);var l,a=Object.assign({},{label:t.label},t.attrs,t.meta),i=a.roles.map(function(e){return e.type="checkbox",e}),o=["required","label","description","class","roles","name"];if(a.name=a.name||n.nameAttr(a.type),-1!==e.inArray(a.type,["checkbox","select","checkbox-group","date","autocomplete"])||a.maxLength||(a.maxLength="",o.push("maxLength")),a.roles={options:i,value:1,type:"checkbox"},t.options){var r=t.options.map(function(e,t){var l={options:[],type:"none"};for(var a in e)if(e.hasOwnProperty(a)){var i={value:e[a],label:a,name:"option-"+a};"selected"===a&&(i.type="checkbox"),l.options.push(i)}return l});a.options={options:r,label:s.labels.options,type:"none"}}return delete a.type,l=n.uniqueArray(o.concat(Object.keys(a))).map(function(e){var t={name:e};return"object"==typeof a[e]?Object.assign(t,a[e]):t.value=a[e],t})},s=e.extend(o,l),c=e(t),d="frmb-"+e("ul[id^=frmb-]").length++,p=1,u=d+"-control-box",m=[{id:"text","class":"icon-text"},{id:"autocomplete","class":"icon-autocomplete"},{id:"select","class":"icon-select"},{id:"rich-text","class":"icon-rich-text"},{id:"date","class":"icon-calendar"},{id:"radio-group","class":"icon-radio-group"},{id:"checkbox","class":"icon-checkbox"},{id:"checkbox-group","class":"icon-checkbox-group"}],f=e("<ul/>",{id:u,"class":"frmb-control"}),v=m.map(function(t){var l=t.id.toCamelCase(),a={label:s.labels[l],meta:{description:"",roles:s.roles},attrs:{type:t.id,"class":t["class"],required:{value:1,type:"checkbox"},name:n.nameAttr(t.id)}};return-1!==e.inArray(t.id,["select","checkbox-group","radio-group"])&&(a.options=[{selected:!1,value:"option-1-value",label:"Option 1 Label"},{selected:!1,value:"option-2-value",label:"Option 2 Label"}]),a.properties=r(a),e("<li/>",a.attrs).data("fieldData",a).html(a.label).removeAttr("type")});f.append(v);var h=e("<h4/>").html(s.labels.editorTitle),b=e("<h4/>").html(s.labels.preview),g=e("<a/>",{id:d+"-export-xml",text:s.labels.viewXML,"class":"view-xml"}),x=e("<a/>",{id:d+"-allow-select",text:s.labels.allowSelect,"class":"allow-select"}).prop("checked","checked"),y=e("<a/>",{id:d+"-edit-xml",text:s.labels.editXML,"class":"edit-xml"}),k=e("<a/>",{id:d+"-edit-names",text:s.labels.editNames,"class":"edit-names"}),w=e("<a/>",{id:d+"-clear-all",text:s.labels.clearAll,"class":"clear-all"}),C=e("<div/>",{id:d+"-save","class":"save-btn-wrap",title:s.labels.save}).html('<a class="save fb-button primary"><span>'+s.labels.save+"</span></a>"),T=e("<div/>",{id:d+"-action-links-inner","class":"action-links-inner"}).append(y," | ",k," | ",x," | ",w," |&nbsp;"),A=e("<span/>",{"class":"dev-mode-link"}).html(s.labels.devMode+" "+s.labels.off),E=e("<div/>",{id:d+"-action-links","class":"action-links"}).append(T,A),M=e("<ul/>").attr("id",d).addClass("frmb").sortable({cursor:"move",opacity:.9,beforeStop:function(t,l){t=t;var a=e("> li",M).length-1,o=l.placeholder.index();i=1>=o||o===a},start:n.startMoving,stop:n.stopMoving,cancel:"input, .disabled, .sortable-options, .add, .btn, .no-drag, .prev-holder select",placeholder:"frmb-placeholder"});f.sortable({helper:"clone",opacity:.9,connectWith:M,cursor:"move",placeholder:"ui-state-highlight",start:n.startMoving,stop:n.stopMoving,revert:150,remove:function(t,l){0===a?f.prepend(l.item):e("li:eq("+(a-1)+")",f).after(l.item)},update:function(t,l){c.stopIndex=0===e("li",M).index(l.item)?"0":e("li",M).index(l.item),e("li",M).index(l.item)<0?e(this).sortable("cancel"):I(l.item,!0)},receive:function(t,l){(l.sender.hasClass("frmb")||l.sender.hasClass("frmb-control"))&&e(l.sender).sortable("cancel")}}),c.before(M).parent().prepend(b).addClass("frmb-wrap").append(E,g,C);var _=e("<div/>",{id:d+"-cb-wrap","class":"cb-wrap"}).append(h,f),O=e(".frmb-wrap").before(_).append(E),L=function(){if(0===e(this).parents("li.disabled").length){if("label"===e(this).name&&""===e(this).val())return alert("Error: "+s.labels.labelEmpty);n.save()}};e("input, select",M).on("change",L),e("input, select",M).on("blur",L),c.getTemplate=function(){var t=""!==c.val()?e.parseXML(c.val()):!1,l=e(t).find("field");if(l.length>0)l.each(function(){I(e(this))});else if(!t){if(s.defaultFields.length)for(var a=s.defaultFields.length-1;a>=0;a--)F(s.defaultFields[a]);else O.addClass("empty").attr("data-content",s.labels.getStarted);D()}};var D=function(){var t='<li class="disabled __POSITION__">__CONTENT__</li>';s.disableFields.before&&!e(".disabled.before",M).length&&M.prepend(t.replace("__POSITION__","before").replace("__CONTENT__",s.disableFields.before)),s.disableFields.after&&!e(".disabled.after",M).length&&M.append(t.replace("__POSITION__","after").replace("__CONTENT__",s.disableFields.after))},I=function(e){var t=e.data("fieldData");F(t),O.removeClass("empty"),D()},F=function(t){var l="",a=n.markup("a",{"class":"del-button btn",title:s.labels.removeMessage,id:"del_"+p},s.labels.remove),i=n.markup("a",{id:"frm-"+p,"class":"toggle-form btn icon-pencil",title:s.labels.hide}),o=n.markup("span",{"class":"field-label"},t.label),r=n.markup("span",{"class":"required-asterisk"},"*"),d=t.description?n.markup("span",{"class":"tooltip-element",tooltip:t.description},"?"):"",u=n.markup("div",{"class":"legend"},[a,o,d,r,i]),m=n.markup("div",{id:"frm-"+p+"-fld","class":"field-properties"},N(t.properties));l=n.markup("li",{id:"frm-"+p+"-item","class":t.attrs.type+" form-field"},[u,B(t),m]),c.stopIndex?e("li",M).eq(c.stopIndex).after(l):M.append(l),e(document.getElementById("frm-"+p+"-item")).hide().slideDown(250),p++,n.save()},q=function(e){var t=[];for(var l in e)e.hasOwnProperty(l)&&t.push(l+'="'+e[l]+'"');return t.join(" ")},N=function(e){return e.map(function(e){var t=n.markup("div",{"class":"field-property "+e.name+"-wrap"},S(e));return t})},S=function G(t){var l=arguments.length<=1||void 0===arguments[1]?0:arguments[1],a=t.name||"",i=(a+"-"+p).replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),o=t.label||s.labels[a.toCamelCase()]||!1,r=t.fields||[],c=t.type||"text",d=t.value||"",u=[];if(t.options&&(l++,r=t.options.map(function(e){return G(e,l)}),r=n.markup("div",{"class":"property-options-"+l},r)),"none"!==c){var m={type:c,name:i,value:d,id:i,"class":"edit-"+a};2===l?m.placeholder=o.charAt(0).toUpperCase()+o.slice(1):1===l&&setTimeout(function(){e(".property-options-1",document.getElementById("frm-"+p+"-item")).sortable()},1e3),u.push(n.markup("input",m))}return o&&u.push(n.markup("label",{"for":i},o)),u.push(u,r),u.join("")},B=function(e){var t={},l=e.attrs.type.toCamelCase();return t.text=function(e){var t=q(e.attrs),a="<input "+t+">",i=e.attrs.value||"",o="<textarea "+t+">"+i+"</textarea>",n='<label for="'+e.attrs.id+'">'+e.label+"</label>",r={};return console.log(l),r.text=n+a,r.password=r.text,r.autocomplete=r.text,r.date=r.text,r.checkbox=a+n,r.radio=r.checkbox,r.textArea=n+o,r.richText=r.textArea,r[l]},t.password=Object.assign(t.text),t.email=t.text,t.date=t.text,t.checkbox=t.text,t.autocomplete=t.text,t.richText=t.text,t.select=function(e){var t=void 0,l=e.attrs,a=function(e){var t=e.selected?"selected":"";return'<option value="'+e.value+'" '+t+">"+e.label+"</option>"},i=void 0;for(e.options.reverse(),i=e.options.length-1;i>=0;i--)t+=a(e.options[i]);return"<"+l.type+">"+t+"</"+l.type+">"},t.checkboxGroup=function(e){return e.options.forEach(function(l){e.attrs.type=e.attrs.type.replace("-group",""),e.attrs.value=l.value,e=Object.assign(e,l),console.log(e.attrs.type),t[e.attrs.type](e)})},t.radioGroup=t.checkboxGroup,'<div class="prev-holder">'+t[l](e)+"</div>"};M.on("click",".remove",function(t){t.preventDefault();var l=e(this).parents(".sortable-options:eq(0)").children("li").length;2>=l?alert("Error: "+s.labels.minOptionMessage):e(this).parent("li").slideUp("250",function(){e(this).remove()})}),M.on("click",".toggle-form",function(t){t.preventDefault();var l=e(this).attr("id");e(this).toggleClass("open").parent().next(".prev-holder").slideToggle(250),e(document.getElementById(l+"-fld")).slideToggle(250,function(){})}),M.on("keyup",".edit-label",function(t){e(".field-label",e(this).closest("li")).html(e(this).val())}),M.on("keyup","input.error",function(){e(this).removeClass("error")}),M.on("keyup",".edit-description",function(t){t.preventDefault();var l=e(".tooltip-element",e(this).closest("li"));if(""!==e(this).val())if(l.length)l.attr("tooltip",e(this).val()).css("display","inline-block");else{var a='<span class="tooltip-element" tooltip="'+e(this).val()+'">?</span>';e(".toggle-form",e(this).closest("li")).before(a)}else l.length&&l.css("display","none")}),M.on("keyup",".edit-name",function(){e(this).val(n.safename(e(this).val())),""===e(this).val()?e(this).addClass("field_error").attr("placeholder",s.labels.cannotBeEmpty):e(this).removeClass("field_error")}),M.on("keyup","input.fld-max-length",function(){e(this).val(n.forceNumber(e(this).val()))}),M.on("click",".del-button",function(t){t.preventDefault();var l=e(this).parents(".form-field:eq(0)");s.showWarning,j(l)});var j=function(t){var l=e("<h3/>").html("<span></span>"+s.labels.warning);e("<div />").append(l,s.labels.fieldRemoveWarning).dialog({modal:!0,resizable:!1,width:300,dialogClass:"ite-warning",buttons:[{text:s.labels.yes,click:function(){n.removeField(t),e(this).dialog("close")}},{text:s.labels.no,click:function(){e(this).dialog("close")}}]})};n.removeField=function(t){t.slideUp(250,function(){e(this).remove(),n.save()})},M.on("click",".edit-required",function(){var t=e(this).parents("li.form-field").find(".required-asterisk");t.toggle()}),M.on("click",".edit-roles",function(){var t=e(this).siblings(".property-options-1"),l=e(this);t.slideToggle(250,function(){l.is(":checked")||e('input[type="checkbox"]',t).removeAttr("checked")})}),M.on("mouseenter","li.disabled .form-element",function(){n.disabledTT(e(this))}),M.on("click",".close-field",function(t){t.preventDefault(),e(this).parents("li.form-field").find(".toggle-form").trigger("click")}),e(".field-properties .fields .remove, .frmb .del-button").on("hover",function(){e(this).parents("li.form-field").toggleClass("delete")}),e(document.getElementById(d+"-export-xml")).click(function(t){t.preventDefault();var l=c.val(),a=e("<pre />").text(l);a.dialog({resizable:!1,modal:!0,width:720,dialogClass:"frmb-xml",overlay:{color:"#333333"}})}),e(document.getElementById(d+"-clear-all")).click(function(e){e.preventDefault(),window.confirm(s.labels.clearAllMessage)&&(M.empty(),c.val(""),n.save(),c.getTemplate())}),e(document.getElementById(d+"-save")).click(function(e){e.preventDefault(),O.hasClass("edit-xml")||n.save(),n.validateForm(e)});var P=!1,X=[],R="68,69,86";e(".save.fb-button").mouseover(function(){P=!0}).mouseout(function(){P=!1}),e(document.documentElement).keydown(function(t){X.push(t.keyCode),X.toString().indexOf(R)>=0&&(e(".action-links").toggle(),e(".view-xml").toggle(),X=[])}),e(".dev-mode-link").click(function(t){t.preventDefault();var l=e(this);O.toggleClass("dev-mode"),l.parent().css("opacity",1),O.hasClass("dev-mode")?(l.siblings(".action-links-inner").css("width","100%"),l.html(s.labels.devMode+" "+s.labels.on).css("color","#8CC63F")):(l.siblings(".action-links-inner").css("width",0),l.html(s.labels.devMode+" "+s.labels.off).css("color","#666666"),P=!1,e(".action-links").toggle(),e(".view-xml").toggle())}),e(document.getElementById(d+"-edit-names")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e(".name_wrap",M).slideToggle(250,function(){O.toggleClass("edit-names")})}),e(document.getElementById(d+"-allow-select")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e(".allow-multi, .select-option",M).slideToggle(250,function(){O.toggleClass("allow-select")})}),e(document.getElementById(d+"-edit-xml")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e("textarea.idea-template").show(),e(".template-textarea-wrap").slideToggle(250),O.toggleClass("edit-xml")}),c.parent().find('p[id*="ideaTemplate"]').remove(),c.wrap('<div class="template-textarea-wrap"/>'),c.getTemplate()};e.fn.formBuilder=function(l){var a=this;return a.each(function(){var a=e(this);if(!a.data("formBuilder")){var i=new t(this,l);a.data("formBuilder",i)}})}}(jQuery),function(e){e.fn.toXML=function(t){var l={prepend:"",attributes:["class"]},a=e.extend(l,t),i="";return this.each(function(){var t=0,l=1;e(this).children().length>=1&&(i+="<form-template>\n	<fields>",e(this).children().each(function(){var o=e(this);if(!o.hasClass("moving")&&!o.hasClass("disabled"))for(var n=0;n<a.attributes.length;n++){var r=e("input.required",o).is(":checked")?'required="true" ':'required="false" ',s=e('input[name="multiple"]',o).is(":checked"),c=s?'style="multiple" ':"",d=o.attr(a.attributes[n]),p='type="'+d+'" ',u='name="'+e("input.fld-name",o).val()+'" ',m='label="'+e("input.fld-label",o).val()+'" ',f=e.map(e("input.roles-field:checked",o),function(e){return e.value}).join(","),v=""!==f?'role="'+f+'" ':"",h='description="'+e("input.fld-description",o).val()+'" ',b=e("input.fld-max-length",o).val(),g='max-length="'+(void 0!==b?b:"")+'" ',x="select"!==d&&"checkbox-group"!==d?"/":"";i+="\n		<field "+u+m+c+v+h+(""!==b&&void 0!==b?g:"")+r+p+x+">",("select"===d||"checkbox-group"===d)&&(l=1,e("input[type=text][class=option]",o).each(function(){if("title"!==e(this).attr("name")){var t=e(this).prev().is(":checked")?' selected="true"':"";i+="\n			<option"+t+">"+e(this).val()+"</option>"}l++}),i+="\n		</field>")}t++}),i+="\n	</fields>\n</form-template>")}),i}}(jQuery);